// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Incident tracking table
model Incident {
  id         String      @id @default(uuid())
  title      String
  status     IncidentStatus @default(ACTIVE)
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  agentRuns  AgentRun[]

  // Link to the affected order (for AI context)
  orderId    String?     @map("order_id")
  order      Order?      @relation(fields: [orderId], references: [id])

  @@map("incidents")
}

enum IncidentStatus {
  ACTIVE
  RESOLVED
  FAILED
}

// Trucks table (Samsara Fleet)
model Truck {
  id          String      @id // e.g., "TRK-882"
  driverName  String      @map("driver_name")
  vehicleType VehicleType @default(REFRIGERATED) @map("vehicle_type")
  status      TruckStatus @default(ACTIVE)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  orders      Order[]

  @@map("trucks")
}

enum VehicleType {
  REFRIGERATED
  DRY_VAN
  FLATBED
  TANKER
}

enum TruckStatus {
  ACTIVE
  IDLE
  MAINTENANCE
  INCIDENT
}

// Buyers table (Restaurant/Client accounts)
model Buyer {
  id          String   @id @default(uuid())
  name        String   // e.g., "Ruth's Chris Steakhouse - Dallas"
  segment     String   // "Fine Dining", "Fast Casual", "Hospitality", "Retail"
  trustScore  Int      @default(95) @map("trust_score") // 0-100, drops on delays
  totalSpend  Float    @default(0) @map("total_spend") // Lifetime value
  orders      Order[]  @relation("OrderBuyers") // Many-to-many relation
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("buyers")
}

// Orders table (Mocking Manhattan TMS)
model Order {
  id          String   @id
  itemName    String   @map("item_name")
  description String?  @default("Standard shipment") // Order description
  orderValue  Float    @default(0) @map("order_value") // Legacy field (now using sellPrice)
  status      String
  carrier     String

  // Assigned truck from Samsara fleet
  truckId     String?  @map("truck_id")
  truck       Truck?   @relation(fields: [truckId], references: [id])

  // Geospatial Data for Route Visualization
  origin      String   @default("Distribution Center")
  destination String   @default("Regional Hub")
  startLat    Float    @default(0) @map("start_lat")
  startLng    Float    @default(0) @map("start_lng")
  endLat      Float    @default(0) @map("end_lat")
  endLng      Float    @default(0) @map("end_lng")
  riskScore   Int      @default(0) @map("risk_score") // 0-100 for color gradient

  // Precomputed route from Mapbox Directions API
  routeGeoJson Json?   @map("route_geojson") // Array of [lng, lat] coordinates
  progress     Int     @default(50) // 0-100, truck position along route

  // --- Financials (The "Business Brain") ---
  costPrice           Float    @default(0) @map("cost_price")           // COGS: What we pay the supplier
  sellPrice           Float    @default(0) @map("sell_price")           // Revenue: What customers pay us
  internalBaseCost    Float    @default(0) @map("internal_base_cost")   // Fixed Logistics Overhead (Warehouse/Admin)
  actualLogisticsCost Float    @default(0) @map("actual_logistics_cost") // Variable: Driver Pay + Fuel + Emergency Fees

  // --- Relationships ---
  buyers      Buyer[]    @relation("OrderBuyers") // Many-to-many: One truck serves multiple restaurants
  incidents   Incident[] // Incidents linked to this order

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("orders")
}

// Agent runs tracking table
model AgentRun {
  id         Int      @id @default(autoincrement())
  runId      String   @unique @map("run_id")
  incidentId String   @map("incident_id")
  agentRole  String   @map("agent_role")
  agentName  String   @map("agent_name")
  summary    String
  status     AgentStatus @default(IDLE)
  logs       Json     @default("[]")
  link       String   @default("")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@map("agent_runs")
}

enum AgentStatus {
  IDLE
  RUNNING
  ACTIVE
  COMPLETED
  FINISHED
  FAILED
}
