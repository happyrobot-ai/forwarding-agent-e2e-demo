// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Incident tracking table
model Incident {
  id          String      @id @default(uuid())
  title       String
  description String?     // Incident description for AI context
  status      IncidentStatus @default(ACTIVE)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  agentRuns   AgentRun[]

  // Link to the affected order (for AI context)
  orderId    String?     @map("order_id")
  order      Order?      @relation(fields: [orderId], references: [id])

  // Smart Recovery: Discovery workflow status
  discoveryStatus DiscoveryStatus @default(PENDING) @map("discovery_status")

  // Smart Recovery: Unified candidates table (service centers, warehouses, drivers)
  candidates  IncidentCandidate[]

  // Unified incident timeline logs (System, Discovery, Agent events)
  logs        IncidentLog[]

  @@map("incidents")
}

// Unified log model for incident timeline
model IncidentLog {
  id          String   @id @default(uuid())

  incidentId  String   @map("incident_id")
  incident    Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  timestamp   DateTime @default(now())
  message     String   // e.g., "Identified 3 repair shops", "Calling Driver..."
  source      String   // "SYSTEM", "ORCHESTRATOR", "DISCOVERY", "AGENT:FACILITY", "AGENT:DRIVER"
  status      String   @default("INFO") // "INFO", "SUCCESS", "WARNING", "ERROR"

  createdAt   DateTime @default(now()) @map("created_at")

  @@map("incident_logs")
}

enum DiscoveryStatus {
  PENDING    // Not yet started
  RUNNING    // Currently scanning for resources
  COMPLETED  // Discovery finished, candidates saved
}

enum CandidateType {
  SERVICE_CENTER
  WAREHOUSE
  DRIVER
}

enum IncidentStatus {
  ACTIVE
  RESOLVED
  FAILED
}

// Trucks table (Samsara Fleet)
model Truck {
  id          String      @id // e.g., "TRK-882"
  driverName  String      @map("driver_name")
  vehicleType VehicleType @default(REFRIGERATED) @map("vehicle_type")
  status      TruckStatus @default(ACTIVE)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  orders      Order[]

  // Reverse relation to incidents where this truck's driver was a candidate
  incidentCandidates IncidentCandidate[]

  @@map("trucks")
}

enum VehicleType {
  REFRIGERATED
  DRY_VAN
  FLATBED
  TANKER
}

enum TruckStatus {
  ACTIVE
  IDLE
  MAINTENANCE
  INCIDENT
}

// Buyers table (Restaurant/Client accounts)
model Buyer {
  id          String   @id @default(uuid())
  name        String   // e.g., "Ruth's Chris Steakhouse - Dallas"
  segment     String   // "Fine Dining", "Fast Casual", "Hospitality", "Retail"
  trustScore  Int      @default(95) @map("trust_score") // 0-100, drops on delays
  totalSpend  Float    @default(0) @map("total_spend") // Lifetime value
  orders      Order[]  @relation("OrderBuyers") // Many-to-many relation
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("buyers")
}

// Orders table (Mocking Manhattan TMS)
model Order {
  id          String   @id
  itemName    String   @map("item_name")
  description String?  @default("Standard shipment") // Order description
  orderValue  Float    @default(0) @map("order_value") // Legacy field (now using sellPrice)
  status      String
  carrier     String

  // Assigned truck from Samsara fleet
  truckId     String?  @map("truck_id")
  truck       Truck?   @relation(fields: [truckId], references: [id])

  // Geospatial Data for Route Visualization
  origin      String   @default("Distribution Center")
  destination String   @default("Regional Hub")
  startLat    Float    @default(0) @map("start_lat")
  startLng    Float    @default(0) @map("start_lng")
  endLat      Float    @default(0) @map("end_lat")
  endLng      Float    @default(0) @map("end_lng")
  riskScore   Int      @default(0) @map("risk_score") // 0-100 for color gradient

  // Precomputed route from Mapbox Directions API
  routeGeoJson    Json?    @map("route_geojson") // Array of [lng, lat] coordinates
  distanceMeters  Float    @default(0) @map("distance_meters") // Route distance from Mapbox
  durationSeconds Float    @default(0) @map("duration_seconds") // Estimated travel time from Mapbox
  progress        Int      @default(50) // 0-100, truck position along route

  // Real timing data
  departedAt       DateTime? @map("departed_at") // When truck left origin (null = not departed)
  estimatedArrival DateTime? @map("estimated_arrival") // Calculated ETA based on departure + duration
  actualArrival    DateTime? @map("actual_arrival") // When actually delivered (for DELIVERED orders)

  // --- Financials (The "Business Brain") ---
  costPrice           Float    @default(0) @map("cost_price")           // COGS: What we pay the supplier
  sellPrice           Float    @default(0) @map("sell_price")           // Revenue: What customers pay us
  internalBaseCost    Float    @default(0) @map("internal_base_cost")   // Fixed Logistics Overhead (Warehouse/Admin)
  actualLogisticsCost Float    @default(0) @map("actual_logistics_cost") // Variable: Driver Pay + Fuel + Emergency Fees

  // --- Relationships ---
  buyers      Buyer[]    @relation("OrderBuyers") // Many-to-many: One truck serves multiple restaurants
  incidents   Incident[] // Incidents linked to this order

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("orders")
}

// Agent runs tracking table
model AgentRun {
  id         Int      @id @default(autoincrement())
  runId      String   @unique @map("run_id")
  incidentId String   @map("incident_id")
  agentRole  String   @map("agent_role")
  agentName  String   @map("agent_name")
  summary    String
  status     AgentStatus @default(IDLE)
  logs       Json     @default("[]")
  link       String   @default("")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@map("agent_runs")
}

enum AgentStatus {
  IDLE
  RUNNING
  ACTIVE
  COMPLETED
  FINISHED
  FAILED
}

// Warehouse/Distribution Center locations
model Warehouse {
  id          String   @id // e.g., "WH-DAL-001"
  name        String
  type        String   // "BROADLINE_HUB", "REGIONAL_HUB"
  address     String
  lat         Float
  lng         Float
  status      String   @default("OPERATIONAL") // OPERATIONAL | CRITICAL | WARNING
  description String?

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Reverse relation to incidents where this warehouse was a candidate
  incidentCandidates IncidentCandidate[]

  @@map("warehouses")
}

// Roadside Assistance Network - contracted repair/service providers
model ServiceCenter {
  id              String   @id // e.g., "SVC-DAL-001"
  name            String   // Company/Shop name
  type            ServiceCenterType @default(REPAIR_SHOP)
  address         String
  lat             Float
  lng             Float
  phone           String
  services        String[] // ["TOWING", "TIRE", "MECHANICAL", "REFRIGERATION", "FUEL"]
  is24Hours       Boolean  @default(false) @map("is_24_hours")
  avgResponseMins Int      @default(45) @map("avg_response_mins") // Average response time
  coverageRadius  Int      @default(50) @map("coverage_radius") // Miles
  status          ServiceCenterStatus @default(AVAILABLE)
  rating          Float    @default(4.5) // 0-5 star rating
  contractTier    String   @default("STANDARD") // "PREFERRED", "STANDARD", "ON_DEMAND"

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Reverse relation to incidents where this center was a candidate
  incidentCandidates IncidentCandidate[]

  @@map("service_centers")
}

// Unified candidate table: Links Incidents to discovered resources (service centers, warehouses, drivers)
model IncidentCandidate {
  id              String   @id @default(uuid())

  incidentId      String   @map("incident_id")
  incident        Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  candidateType   CandidateType @map("candidate_type")

  // Polymorphic FKs (only one set based on candidateType)
  serviceCenterId String?  @map("service_center_id")
  serviceCenter   ServiceCenter? @relation(fields: [serviceCenterId], references: [id], onDelete: Cascade)

  warehouseId     String?  @map("warehouse_id")
  warehouse       Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  truckId         String?  @map("truck_id")
  truck           Truck?   @relation(fields: [truckId], references: [id], onDelete: Cascade)

  // Common fields
  distance        Float    // Distance from incident truck in miles
  rank            Int      // 1 = closest, 2 = second, etc.

  // Driver-specific snapshot (null for non-drivers)
  orderId         String?  @map("order_id")  // Driver's current order ID (for fetching route/details)
  lat             Float?   // Driver's current lat at discovery time
  lng             Float?   // Driver's current lng at discovery time
  currentLocation String?  @map("current_location")  // Delivery destination name
  status          String?  // "DELIVERED" or "COMPLETING" (driver only)
  progress        Int?     // Progress percentage (driver only)

  // Nearest Sysco hub for trailer drop-off (driver only)
  nearestDropOffId   String?  @map("nearest_dropoff_id")
  nearestDropOffName String?  @map("nearest_dropoff_name")
  nearestDropOffDistance Float? @map("nearest_dropoff_distance")

  createdAt       DateTime @default(now()) @map("created_at")

  @@map("incident_candidates")
}

enum ServiceCenterType {
  TRUCK_STOP        // Major truck stops (Loves, Pilot, TA)
  REPAIR_SHOP       // Dedicated truck repair facilities
  MOBILE_MECHANIC   // On-site repair services
  TOWING_SERVICE    // Heavy-duty towing companies
  TIRE_CENTER       // Tire specialists
  REFRIGERATION     // Reefer repair specialists
}

enum ServiceCenterStatus {
  AVAILABLE   // Ready to dispatch
  BUSY        // Currently handling another call
  OFFLINE     // Closed or unavailable
}
