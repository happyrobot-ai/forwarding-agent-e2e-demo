// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Incident tracking table
model Incident {
  id          String      @id @default(uuid())
  title       String
  description String?     // Incident description for AI context
  status      IncidentStatus @default(ACTIVE)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  agentRuns   AgentRun[]

  // Link to the affected order (for AI context)
  orderId    String?     @map("order_id")
  order      Order?      @relation(fields: [orderId], references: [id])

  // Smart Recovery: Discovery workflow status
  discoveryStatus DiscoveryStatus @default(PENDING) @map("discovery_status")

  // Smart Recovery: Selected resources (persisted for historical view)
  selectedFacilityId String? @map("selected_facility_id")
  selectedDriverId   String? @map("selected_driver_id")

  // Workflow trigger guard (prevents duplicate triggers from multiple clients)
  workflowTriggered Boolean @default(false) @map("workflow_triggered")

  // Smart Recovery: Unified candidates table (service centers, warehouses, drivers)
  candidates  IncidentCandidate[]

  // Unified incident timeline logs (System, Discovery, Agent events)
  logs        IncidentLog[]

  @@map("incidents")
}

// Unified log model for incident timeline
model IncidentLog {
  id          String   @id @default(uuid())

  incidentId  String   @map("incident_id")
  incident    Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  timestamp   DateTime @default(now())
  message     String   // e.g., "Identified 3 repair shops", "Calling Driver..."
  source      String   // "SYSTEM", "ORCHESTRATOR", "DISCOVERY", "AGENT:FACILITY", "AGENT:DRIVER"
  status      String   @default("INFO") // "INFO", "SUCCESS", "WARNING", "ERROR"

  createdAt   DateTime @default(now()) @map("created_at")

  @@map("incident_logs")
}

enum DiscoveryStatus {
  PENDING    // Not yet started
  RUNNING    // Currently scanning for resources
  COMPLETED  // Discovery finished, candidates saved
}

enum CandidateType {
  SERVICE_CENTER
  WAREHOUSE
  DRIVER
}

enum IncidentStatus {
  ACTIVE
  RESOLVED
  FAILED
}

// Trucks table (Samsara Fleet)
model Truck {
  id          String      @id // e.g., "TRK-882"
  driverName  String      @map("driver_name")
  vehicleType VehicleType @default(REFRIGERATED) @map("vehicle_type")
  status      TruckStatus @default(ACTIVE)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  orders      Order[]

  // Reverse relation to incidents where this truck's driver was a candidate
  incidentCandidates IncidentCandidate[]

  @@map("trucks")
}

enum VehicleType {
  REFRIGERATED
  DRY_VAN
  FLATBED
  TANKER
}

enum TruckStatus {
  ACTIVE
  IDLE
  MAINTENANCE
  INCIDENT
}

// Buyers table (Restaurant/Client accounts)
model Buyer {
  id          String   @id @default(uuid())
  name        String   // e.g., "Ruth's Chris Steakhouse - Dallas"
  segment     String   // "Fine Dining", "Fast Casual", "Hospitality", "Retail"
  trustScore  Int      @default(95) @map("trust_score") // 0-100, drops on delays
  totalSpend  Float    @default(0) @map("total_spend") // Lifetime value
  orders      Order[]  @relation("OrderBuyers") // Many-to-many relation
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("buyers")
}

// Orders table (Mocking Manhattan TMS)
model Order {
  id          String   @id
  itemName    String   @map("item_name")
  description String?  @default("Standard shipment") // Order description
  orderValue  Float    @default(0) @map("order_value") // Legacy field (now using sellPrice)
  status      String
  carrier     String

  // Assigned truck from Samsara fleet
  truckId     String?  @map("truck_id")
  truck       Truck?   @relation(fields: [truckId], references: [id])

  // Geospatial Data for Route Visualization
  origin      String   @default("Distribution Center")
  destination String   @default("Regional Hub")
  startLat    Float    @default(0) @map("start_lat")
  startLng    Float    @default(0) @map("start_lng")
  endLat      Float    @default(0) @map("end_lat")
  endLng      Float    @default(0) @map("end_lng")
  riskScore   Int      @default(0) @map("risk_score") // 0-100 for color gradient

  // Precomputed route from Mapbox Directions API
  routeGeoJson    Json?    @map("route_geojson") // Array of [lng, lat] coordinates
  distanceMeters  Float    @default(0) @map("distance_meters") // Route distance from Mapbox
  durationSeconds Float    @default(0) @map("duration_seconds") // Estimated travel time from Mapbox
  progress        Int      @default(50) // 0-100, truck position along route

  // Real timing data
  departedAt       DateTime? @map("departed_at") // When truck left origin (null = not departed)
  estimatedArrival DateTime? @map("estimated_arrival") // Calculated ETA based on departure + duration
  actualArrival    DateTime? @map("actual_arrival") // When actually delivered (for DELIVERED orders)

  // --- Financials (The "Business Brain") ---
  costPrice           Float    @default(0) @map("cost_price")           // COGS: What we pay the supplier
  sellPrice           Float    @default(0) @map("sell_price")           // Revenue: What customers pay us
  internalBaseCost    Float    @default(0) @map("internal_base_cost")   // Fixed Logistics Overhead (Warehouse/Admin)
  actualLogisticsCost Float    @default(0) @map("actual_logistics_cost") // Variable: Driver Pay + Fuel + Emergency Fees

  // --- Relationships ---
  buyers      Buyer[]    @relation("OrderBuyers") // Many-to-many: One truck serves multiple restaurants
  incidents   Incident[] // Incidents linked to this order

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("orders")
}

// Agent runs tracking table (for old Sysco demo - keep for compatibility)
model AgentRun {
  id         Int      @id @default(autoincrement())
  runId      String   @unique @map("run_id")
  incidentId String   @map("incident_id")
  agentRole  String   @map("agent_role")
  agentName  String   @map("agent_name")
  summary    String
  status     AgentStatus @default(IDLE)
  logs       Json     @default("[]")
  link       String   @default("")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@map("agent_runs")
}

enum AgentStatus {
  IDLE
  RUNNING
  ACTIVE
  COMPLETED
  FINISHED
  FAILED
}

// HappyRobot workflow runs tracking (for DSV demo)
model HappyRobotRun {
  id          String   @id @default(uuid())
  runId       String   @unique @map("run_id") // HappyRobot's run_xxx ID

  // Context - what triggered this run
  contextType String   @map("context_type") // "email", "shipment", "temperature_alert"
  contextId   String   @map("context_id")   // Email ID, Shipment ID, etc.

  // Metadata
  name        String   // Display name for UI
  description String?  // What this run is doing

  // Status tracking
  status      HappyRobotStatus @default(PENDING)

  // Store logs/results from HappyRobot
  metadata    Json     @default("{}")

  // HappyRobot Platform UI link
  platformUrl String?  @map("platform_url")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([contextId])
  @@index([status])
  @@map("happyrobot_runs")
}

enum HappyRobotStatus {
  PENDING    // Created, not yet started
  RUNNING    // Currently executing
  COMPLETED  // Finished successfully
  FAILED     // Execution failed
  CANCELED   // Manually canceled
}

// Warehouse/Distribution Center locations
model Warehouse {
  id          String   @id // e.g., "WH-DAL-001"
  name        String
  type        String   // "BROADLINE_HUB", "REGIONAL_HUB"
  address     String
  lat         Float
  lng         Float
  status      String   @default("OPERATIONAL") // OPERATIONAL | CRITICAL | WARNING
  description String?

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Reverse relation to incidents where this warehouse was a candidate
  incidentCandidates IncidentCandidate[]

  @@map("warehouses")
}

// Roadside Assistance Network - contracted repair/service providers
model ServiceCenter {
  id              String   @id // e.g., "SVC-DAL-001"
  name            String   // Company/Shop name
  type            ServiceCenterType @default(REPAIR_SHOP)
  address         String
  lat             Float
  lng             Float
  phone           String
  services        String[] // ["TOWING", "TIRE", "MECHANICAL", "REFRIGERATION", "FUEL"]
  is24Hours       Boolean  @default(false) @map("is_24_hours")
  avgResponseMins Int      @default(45) @map("avg_response_mins") // Average response time
  coverageRadius  Int      @default(50) @map("coverage_radius") // Miles
  status          ServiceCenterStatus @default(AVAILABLE)
  rating          Float    @default(4.5) // 0-5 star rating
  contractTier    String   @default("STANDARD") // "PREFERRED", "STANDARD", "ON_DEMAND"

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Reverse relation to incidents where this center was a candidate
  incidentCandidates IncidentCandidate[]

  @@map("service_centers")
}

// Unified candidate table: Links Incidents to discovered resources (service centers, warehouses, drivers)
model IncidentCandidate {
  id              String   @id @default(uuid())

  incidentId      String   @map("incident_id")
  incident        Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  candidateType   CandidateType @map("candidate_type")

  // Polymorphic FKs (only one set based on candidateType)
  serviceCenterId String?  @map("service_center_id")
  serviceCenter   ServiceCenter? @relation(fields: [serviceCenterId], references: [id], onDelete: Cascade)

  warehouseId     String?  @map("warehouse_id")
  warehouse       Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  truckId         String?  @map("truck_id")
  truck           Truck?   @relation(fields: [truckId], references: [id], onDelete: Cascade)

  // Common fields
  distance        Float    // Distance from incident truck in miles
  rank            Int      // 1 = closest, 2 = second, etc.

  // Driver-specific snapshot (null for non-drivers)
  orderId         String?  @map("order_id")  // Driver's current order ID (for fetching route/details)
  lat             Float?   // Driver's current lat at discovery time
  lng             Float?   // Driver's current lng at discovery time
  currentLocation String?  @map("current_location")  // Delivery destination name
  status          String?  // "DELIVERED" or "COMPLETING" (driver only)
  progress        Int?     // Progress percentage (driver only)

  // Nearest Sysco hub for trailer drop-off (driver only)
  nearestDropOffId   String?  @map("nearest_dropoff_id")
  nearestDropOffName String?  @map("nearest_dropoff_name")
  nearestDropOffDistance Float? @map("nearest_dropoff_distance")

  createdAt       DateTime @default(now()) @map("created_at")

  @@map("incident_candidates")
}

enum ServiceCenterType {
  TRUCK_STOP        // Major truck stops (Loves, Pilot, TA)
  REPAIR_SHOP       // Dedicated truck repair facilities
  MOBILE_MECHANIC   // On-site repair services
  TOWING_SERVICE    // Heavy-duty towing companies
  TIRE_CENTER       // Tire specialists
  REFRIGERATION     // Reefer repair specialists
}

enum ServiceCenterStatus {
  AVAILABLE   // Ready to dispatch
  BUSY        // Currently handling another call
  OFFLINE     // Closed or unavailable
}

// ===== DSV FREIGHT FORWARDING MODELS =====

// Email inbox classification system
model Email {
  id              String   @id @default(uuid())
  emailId         String   @unique @map("email_id")
  threadId        String   @map("thread_id")

  fromName        String   @map("from_name")
  fromEmail       String   @map("from_email")
  fromCompany     String   @map("from_company")
  toEmail         String   @map("to_email")

  subject         String
  receivedAt      DateTime @map("received_at")
  classification  String   // QUOTE_REQUEST, BOOKING_CONFIRMATION, STATUS_INQUIRY, etc.
  intent          String   // REQUEST_QUOTE, TRACK_SHIPMENT, etc.
  priority        String   // URGENT, HIGH, MEDIUM, STANDARD
  status          String   // NEW, PENDING, PROCESSED, COMPLETED

  assignedRepName  String?  @map("assigned_rep_name")
  assignedRepEmail String?  @map("assigned_rep_email")

  linkedShipment  String?  @map("linked_shipment")
  summary         String
  missingInfo     String[] @map("missing_info")
  tags            String[]
  highlight       Boolean  @default(false)

  createdAt       DateTime @default(now()) @map("created_at")

  @@map("emails")
}

// Booking/Quotation system
model Booking {
  id              String   @id @default(uuid())
  bookingNumber   String   @unique @map("booking_number")
  quotationNumber String   @map("quotation_number")
  shipmentNumber  String?  @map("shipment_number")
  mawbNumber      String?  @map("mawb_number")

  customerCode    String   @map("customer_code")
  customerName    String   @map("customer_name")
  customerReference String @map("customer_reference")

  origin          String
  originCode      String   @map("origin_code")
  destination     String
  destinationCode String   @map("destination_code")

  carrier         String
  carrierCode     String   @map("carrier_code")
  flightNumber    String?  @map("flight_number")

  commodity       String
  pieces          Int
  weight          Float
  weightUnit      String   @map("weight_unit")
  volume          Float
  volumeUnit      String   @map("volume_unit")

  temperatureSensitive Boolean @default(false) @map("temperature_sensitive")
  temperatureMin       Float?  @map("temperature_min")
  temperatureMax       Float?  @map("temperature_max")
  temperatureSetPoint  Float?  @map("temperature_set_point")
  temperatureUnit      String? @map("temperature_unit")

  status          String   // CONFIRMED, IN_TRANSIT, DELIVERED, etc.
  quotationData   Json     @map("quotation_data") // Full quotation JSON

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("bookings")
}

// Air freight shipments
model Shipment {
  id                String   @id @default(uuid())
  shipmentId        String   @unique @map("shipment_id")
  mawbNumber        String   @map("mawb_number")
  bookingNumber     String?  @map("booking_number")

  customerCode      String   @map("customer_code")
  customerName      String   @map("customer_name")

  originCode        String   @map("origin_code")
  originName        String   @map("origin_name")
  destinationCode   String   @map("destination_code")
  destinationName   String   @map("destination_name")

  carrier           String
  carrierCode       String   @map("carrier_code")
  flightNumber      String   @map("flight_number")

  status            String   // IN_FLIGHT, ARRIVED, ALERT, etc.
  alertType         String?  @map("alert_type")
  alertSeverity     String?  @map("alert_severity")

  temperatureSensitive Boolean @default(false) @map("temperature_sensitive")
  temperatureMin       Float?  @map("temperature_min")
  temperatureMax       Float?  @map("temperature_max")
  temperatureUnit      String? @map("temperature_unit")

  currentLat        Float?   @map("current_lat")
  currentLng        Float?   @map("current_lng")
  currentLocation   String?  @map("current_location")

  progress          Int      @default(0) // 0-100
  lastUpdate        DateTime @default(now()) @map("last_update")

  milestones        ShipmentMilestone[]

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("shipments")
}

// Shipment milestone tracking
model ShipmentMilestone {
  id          String    @id @default(uuid())

  shipmentId  String    @map("shipment_id")
  shipment    Shipment  @relation(fields: [shipmentId], references: [shipmentId], onDelete: Cascade)

  code        String    // BKD, RCS, DEP, ARR, DLV, etc.
  description String
  location    String
  facility    String?
  flight      String?

  planned     DateTime?
  actual      DateTime?
  status      String    // PENDING, IN_PROGRESS, COMPLETED, ALERT

  temperature Float?    // Temperature reading at this milestone
  alert       Json?     // Alert details if any
  note        String?   // Additional notes

  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("shipment_milestones")
}
